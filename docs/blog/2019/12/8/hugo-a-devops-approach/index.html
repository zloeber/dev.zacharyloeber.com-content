<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Zachary Loeber">
        <meta name="description" content="Zachary Loeber&#39;s Personal Site">
        <meta name="keywords" content="blog,personal,devops,infrastructure,code,cloud,Azure,AWS,Kubernetes,Docker">
        <meta name="generator" content="Hugo 0.59.1" />
        <title> Hugo - A Devops Approach | Zachary Loeber</title>
        <meta name="description" content="Hugo - A Devops Approach - Zachary Loeber&#39;s Personal Site">
        <meta itemprop="name" content="Hugo - A Devops Approach">
        <meta itemprop="description" content="Hugo - A Devops Approach - Zachary Loeber&#39;s Personal Site">
        <meta property="og:title" content="Hugo - A Devops Approach">
        <meta property="og:description" content="Hugo - A Devops Approach - Zachary Loeber&#39;s Personal Site">
        <meta property="og:image" content="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?size=200">
        <meta property="og:url" content="https://zacharyloeber-dev.onrender.com/blog/2019/12/8/hugo-a-devops-approach/">
        <meta property="og:site_name" content="Zachary Loeber">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="https://zacharyloeber-dev.onrender.com/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://zacharyloeber-dev.onrender.com/favicon-16x16.png" sizes="16x16">

	
	  <link href="/blog/2019/12/8/hugo-a-devops-approach/" rel="alternate" type="application/rss+xml" title="Zachary Loeber" />
	  <link href="/blog/2019/12/8/hugo-a-devops-approach/" rel="feed" type="application/rss+xml" title="Zachary Loeber" />
	

        
        
        
        
        <link rel="stylesheet" href="/sass/combined.min.5f50be91a665634f9dfed5900bc388393fc430e3369d58e73b8375457a6df832.css">

        

        
            
                <link rel="stylesheet" href="https://zacharyloeber-dev.onrender.com/css/mermaid.css">
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav class="permanentTopNav">

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="/" target="">Home</a></li>
                
            
                
                    <li><a href="https://zacharyloeber-dev.onrender.com/page/about/">About</a></li>
                
            
                
                    <li><a href="https://zacharyloeber-dev.onrender.com/page/about-me/">About Me</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="/">Zachary Loeber</a></h3>
            
                <span class="subtitle">The personal website of Zachary Loeber.</span>
            
        </div>

    

        
        <div class="toggler permanentTopNav">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="https://zacharyloeber-dev.onrender.com/blog/2019/12/8/hugo-a-devops-approach/">
    <i class="fa fa-fw fa-pencil"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="https://zacharyloeber-dev.onrender.com/blog/2019/12/8/hugo-a-devops-approach/">Hugo - A Devops Approach</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2019-12-08</span>
            
        

        
            <span class="readingTime">10 min read</span>
        

        
            <span class="categories">
                
                    <a href="/categories/blog">blog</a>
                
                    <a href="/categories/azure">azure</a>
                
                    <a href="/categories/devops">devops</a>
                
                    <a href="/categories/pipeline">pipeline</a>
                
            </span>
        

        
            <span class="author"><a href="/author/zachary-loeber">Zachary Loeber</a></span>
        
    </div>

    
        <p>I&rsquo;ve updated my site to use hugo some time ago. Recently I&rsquo;ve found some time to add a deployment pipeline for this site as well. This short article will cover how the pipeline code works and dive into multi-stage pipelines.</p>

<h2 id="introduction">Introduction</h2>

<p>As I work in the industry I sometimes forget to update the world on what I&rsquo;m doing. It has been almost a full year since I last posted anything to so it was long past time to get more content out there. Problem was, I forgot how to even deploy to my own site after such a long duration. This time I figured I&rsquo;d just setup a proper pipeline to get things going again.</p>

<p>Here is the stack I&rsquo;ve landed with for this website:</p>

<ul>
<li>Static Site Generator: Hugo</li>
<li>DNS Hosting: Cloudflare.com</li>
<li>CDN: Cloudflare.com</li>
<li>DNS Registrar: Namecheap.com</li>
<li>Git Hosting: Github.com</li>
<li>Web Content Hosting #1: Github Pages</li>
<li>Web Content Hosting #2: Render.com</li>
<li>Pipeline Platform: Azure Devops</li>
</ul>

<p>The only cost in all of this is the custom domain name and some time.</p>

<h2 id="the-process-tldr">The Process (TLDR)</h2>

<p>End to end, the process for this looks a bit like this:</p>

<ol>
<li>Purchase your custom domain name (namecheap.com) <strong>NOTE: this is the only cost for this entire setup and is not strictly required</strong>

<ol>
<li>Optionally, transfer the domain name to Cloudflare.com (they are not actually a registrar you can buy domains from but you can transfer to them as a hosting registrar once you own one it seems)</li>
</ol></li>
<li>Create new private repo in github for authoring content. (ie. yoursite.com)

<ol>
<li>Optionally, setup a github ssh key to make your life easier.</li>
</ol></li>
<li>Create a new public repo in github for publishing your production site (ie. yoursite.com-content).</li>
<li>Create a new public repo in github for publishing draft/development content (ie. dev.yoursite.com-content)</li>
<li>Create a new public repo in github to host your Azure Devops (ADO) pipeline template code

<ol>
<li>You may be able to reference my repo but that may not be wise as I may update things at anytime.</li>
</ol></li>
<li>Download hugo binary</li>
<li>Create new hugo site</li>
<li>Initialize local git repo in the generated site folder</li>
<li>Add submodule for some hugo theme to the hugo site</li>
<li>Add content from 10+ years of blogging&hellip;</li>
<li>Push repo to github authoring site as the upstream source</li>
<li>Add a &lsquo;develop&rsquo; branch for the dev version of your site</li>
<li>Push up your develop branch</li>
<li>Create personal azure devops account (dev.azure.com)</li>
<li>Create a service connector to github and authorize access to all your repos</li>
</ol>

<p>This will set the stage for you to add content to your site in a development environment for review, then approve for release. The workflow for this will be a bit like the following sequence diagram when complete.</p>

<p><img src="/images/sequence-diagram-hugo-flow.png" alt="" /></p>

<p>To make any of this work we need a few pipelines in ADO. One to create our hugo site content as an artifact and another to shove the deployment content into our repositories. We will use Azure Devops multi-stage pipelines and templates to get this in place.</p>

<h2 id="the-pipeline-code">The Pipeline Code</h2>

<p>I&rsquo;ve found that the best way to start working on a pipeline is to declaratively layout the required manifest in what you would like the finished state to look like first. Once you have this, adding the template components is pretty easy.</p>

<blockquote>
<p>NOTE: If you start with the imperative code first, which I have done before, you may as well just throw it all into a Makefile and then pluck out the parts you need for your pipeline pieces later. But I promise you will be doing more work this way than you might otherwise need to do. If you do your devops work with an end state in mind everything else will fall into place, I promise.</p>
</blockquote>

<p>My current site azure-pipeline.yml code looks very similar to what I initially put down for my first draft. A full pipeline for my develop branch looks like the following:</p>

<pre><code>name: $(BuildDefinitionName).$(DayOfYear)$(Rev:.r)
trigger:
  batch: true
  branches:
    include:
    - master
    - develop

# Don't trigger on PRs
pr: none

resources:         
  repositories:
  - repository: pipelines
    type: github
    endpoint: github_services
    name: zloeber/azure-pipeline-library

stages:
## Build Hugo site (DEV)
- ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/develop') }}:
  - template: build/hugo-generate.yml@pipelines
    parameters:
      initialize: true
      baseurl: 'https://zacharyloeber-dev.onrender.com/'
      testhtml: 'true'
      staticpath: './docs'
      contentpath: './sites/zacharyloeber.com'
      drafts: 'true'
  - template: deploy/git-folder.yml@pipelines
    parameters:
      repo: 'https://github.com/zloeber/dev.zacharyloeber.com-content.git'
      branch: 'master'
      path: 'docs'
      environment: 'dev'

## Build Hugo site (PROD)
- ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/master') }}:
  - template: build/hugo-generate.yml@pipelines
    parameters:
      initialize: true
      site: 'zacharyloeber.com'
      baseurl: 'https://zacharyloeber.com/'
      staticpath: 'docs'
      contentpath: 'sites/zacharyloeber.com'
      testhtml: 'false'
  - template: deploy/git-folder.yml@pipelines
    parameters:
      repo: 'https://github.com/zloeber/zacharyloeber.com-content.git'
      branch: 'master'
      path: 'docs'
      environment: 'production'
</code></pre>

<p>I added some additional variables which could be cleaned up and simplified further of course. I also have a carry over sub-folder layout for my site that allows me to publish the same site to multiple URLs.</p>

<blockquote>
<p>You will notice that I have stages run only for specific branches. This is only one way to manage this process and works well enough for me. It can be used to integrate well with a variety of git branching models.</p>
</blockquote>

<h3 id="pipeline-template-code">Pipeline Template Code</h3>

<p>Using the deployment above we can infer that a build and a release template will be required. So I created them and put them in their own repo for future site usage <a href="https://github.com/zloeber/azure-pipeline-library">at this github repo</a>.</p>

<p>I found it best to break down my templates based on build and deploy first, then go further into jobs or steps as I progress. Here is the hugo build pipeline:</p>

<pre><code class="language-bash">parameters:
  initialize: true
  version: '0.59.1'
  disqusshortname: ''
  binpath: '~/.local/bin' ## Binary path (default is usually ok)
  staticpath: './static'  ## Hugo static output path (default is usually ok)
  contentpath: './content' ## Site content path (default is usually ok)
  baseurl: ''
  testhtml: false
  artifact: 'artifact'  ## Artifact name (if you are generating multiple sites in one pipeline you may need to change this)
  drafts: 'false' ## to publish drafts set to 'true'

stages:
- stage: Build_Hugo_Site
  displayName: 'Build Site: ${{ parameters.baseurl }}'
  jobs:
  - job: hugo_generate
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
      clean: true
      submodules: true
      persistCredentials: true
    - ${{ if eq(parameters.initialize, 'true') }}:
      - template: ../jobs/install-hugo.yml
        parameters:
          version: ${{ parameters.version }}
          binpath: '${{ parameters.binpath }}'
    - bash: |
        mkdir -p ${STATICPATH}
        # This is required for publishing to github pages and custom domains
        echo $(basename ${BASEURL}) &gt; ./${STATICPATH}/CNAME
        if [ $DRAFTS = 'true' ]; then
          echo &quot;Building Drafts&quot;
          BUILDDRAFTS=--buildDrafts
        else
          BUILDDRAFTS=&quot;&quot;
        fi
        echo &quot;BASEURL: ${BASEURL}&quot;
        echo &quot;LAYOUTDIR: ${LAYOUTDIR}&quot;
        echo &quot;CONTENTPATH: ${CONTENTPATH}&quot;
        echo &quot;STATICPATH: ${STATICPATH}&quot;
        echo &quot;BUILDDRAFTS: ${BUILDDRAFTS}&quot;
        ${BINPATH}/hugo \
          --themesDir themes \
          --layoutDir ${LAYOUTDIR} \
          --configDir ./ \
          -e production \
          --contentDir &quot;${CONTENTPATH}&quot; \
          --config config.toml \
          --baseURL ${BASEURL} \
          --destination &quot;${STATICPATH}&quot; \
          --gc ${BUILDDRAFTS}
      displayName: 'Generate Site (${{ parameters.baseurl }})'
      env:
        STATICPATH: ${{ parameters.staticpath }}
        CONTENTPATH: '${{ parameters.contentpath }}'
        BINPATH: '${{ parameters.binpath }}'
        BASEURL: '${{ parameters.baseurl }}'
        LAYOUTDIR: 'themes/${{ parameters.theme }}/layouts'
        HUGO_DISQUSSHORTNAME: '${{ parameters.disqusshortname }}'
        DRAFTS: ${{ parameters.drafts }}
    - task: ArchiveFiles@2
      displayName: 'Archive Artifacts'
      inputs:
        rootFolderOrFile: ./${{ parameters.staticpath }}
        includeRootFolder: false
        archiveType: tar
        tarCompression: gz
        archiveFile: $(Pipeline.Workspace)/${{ parameters.artifact }}.tar.gz
        replaceExistingArchive: true
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: $(Pipeline.Workspace)/${{ parameters.artifact }}.tar.gz
        artifactName: ${{ parameters.artifact }}
    - ${{ if eq(parameters.testhtml, 'true') }}:
      - template: ../jobs/test-html.yml
        parameters:
          initialize: ${{ parameters.initialize }}
          binpath: '${{ parameters.binpath }}'
          path: '${{ parameters.staticpath }}'
</code></pre>

<p>This builds the site according to your site config.toml file which should include most of your settings. I also allow for different content and output paths.</p>

<p>And the deployment stage takes the packaged artifact (tar.gz file) and extracts it into a specificed git repo folder of your choosing. This assumes the repo is in github as well and that your created service endpoint for it has access. The release pipeline WILL clear out and overwrite anything in that folder then force pull the changes.</p>

<p>In our case, we shove the output of hugo into a repo&rsquo;s docs folder to make it easier to publish via github pages later (a manual config setting on the repo btw). The release pipeline is pretty simple and also defines an environment which also allows you to setup some gating around final releases if you so desire (bleeding edge ADO manual setting currently).</p>

<pre><code class="language-bash">## Deploy an artifact bundle (tar.gz) from an azure pipeline to another git repo using inherited credentials.
## Author: Zachary Loeber
parameters:
  repo: ''
  branch: 'master'
  path: 'docs'
  environment: ''
  pipelineartifact: 'artifact'
  artifact: 'artifact.tar.gz'

stages:
- stage: Deploy_To_Repo
  displayName: 'Deploy: ${{ parameters.artifact }}'
  jobs:
  - deployment: deploy_repo_content
    condition: succeeded()
    pool:
      vmImage: ubuntu-latest
    environment: ${{ parameters.environment }}
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            clean: true
            submodules: true
            persistCredentials: true
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: '${{ parameters.pipelineartifact }}'
              targetPath: $(Pipeline.Workspace)/_artifact
          - bash: |
              echo &quot;Pulling in repo&quot;
              gitorigin=`git config remote.origin.url`
              gitextraheader=`git config &quot;http.${gitorigin}.extraheader&quot;`
              rm -rf _deploy
              echo &quot;Cloning ${REPO}&quot;
              git clone -c http.extraheader=&quot;${gitextraheader}&quot; --depth 1 --branch ${BRANCH} ${REPO} _deploy
              echo &quot;Removing ${REPOPATH} contents and overwriting with artifact contents&quot;
              rm -rf ./_deploy/${REPOPATH}/*
              mkdir -p ./_deploy/${REPOPATH}
              tar -xzvf ${ARTIFACTPATH}/${ARTIFACT} --directory ./_deploy/${REPOPATH}
              cd ./_deploy
              git config user.email &quot;cicd@azurepipelines&quot;
              git config user.name &quot;cicd&quot;
              git add --all .
              git commit --no-verify -m 'cicd: Automated Deployment'
              git -c http.extraheader=&quot;${gitextraheader}&quot; push
            displayName: 'Git Content Deployment'
            env:
              REPO: ${{ parameters.repo }}
              BRANCH: ${{ parameters.branch }}
              REPOPATH: ${{ parameters.path }}
              ARTIFACTPATH: $(Pipeline.Workspace)/_artifact
              ARTIFACT: ${{ parameters.artifact }}
</code></pre>

<p>The hardest part of all of this was figuring out how to pass the service connection authentication through to the deployment stage. We force another checkout of the current repo to ensure that the proper authentication headers are in place (which we then strip out for our own use). Otherwise you can also use a PAT and maunually add in a username/password via environment variables in the pipeline. I opted not to do that to ease manual efforts a little.</p>

<p>Oh, I also broke down a few other steps for repeat use. This includes htmltest and hugo binary installs well as the htmltest run itself. This was largely to make things a bit more clean and composable. But honestly, it was more to have additional lego pieces in my arsenal for future pipelines :) You can find them in the pipeline repository referenced earlier.</p>

<h2 id="publish-a-draft-post">Publish A Draft Post</h2>

<p>To create and publish a draft post just ensure you are on the develop branch, create a post, then push it up to develop.  Let the pipeline do its thing and review your dev site.</p>

<pre><code class="language-bash">git checkout develop
make new/post some_awesome_content.md
## Creates &lt;site content&gt;/posts/some_awesome_content.md for you to work on
git add --all . &amp;&amp; git commit -m 'post: some awesome content added'
git push origin develop
</code></pre>

<h2 id="promote-to-production">Promote to Production</h2>

<p>To promote your draft to production simply update the post&rsquo;s &lsquo;draft&rsquo; front matter to false (or delete it). Then publish to dev, and merge to prod.</p>

<pre><code class="language-bash">## Review your dev site, looks good? Ok, then update your new post to non-draft status by editing the front matter to remove the draft config.
git add --all . &amp;&amp; git commit -m 'post: some awesome content approved to publish'
git push origin develop
git checkout master
git merge develop
git add --all . &amp;&amp; git commit -m 'post: some awesome content approved to publish'
</code></pre>

<h2 id="last-thoughts">Last Thoughts</h2>

<p>I don&rsquo;t know if I should be proud or depressed that over 10 years of original site content can be compiled into a static site in under a minute. Either way, the entire process for deployment of such a thing is certainly a fun little side project. Static site generators are <strong>extremely</strong> DevOps friendly as well. I highly recommend anyone looking for more devops acumen give it a shot for their own site. You will hone or even learn foundational devops knowledge in several areas including:</p>

<ul>
<li>Version Control (git)</li>
<li>CI/CD</li>
<li>Pipelines</li>
<li>Cloud integrations</li>
<li>DNS</li>
<li>Webhooks/Triggers</li>
</ul>

<p>Extra points if you can adhere to some best practice rules in your deployment like:</p>

<ul>
<li>Emit a stand alone artifact from CI</li>
<li>Use some form of git branch management</li>
</ul>

<p>That&rsquo;s about all I have for this post. Only one real post in this year but I promise I&rsquo;ve got more to come as I round back on all I&rsquo;ve learned in my deep diving into the world or kubernetes, devops, and infrastructure as code in the last few years.</p>
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="/tags/blog">blog</a>
                
                    <a href="/tags/azure">azure</a>
                
                    <a href="/tags/devops">devops</a>
                
                    <a href="/tags/pipeline">pipeline</a>
                
                    <a href="/tags/automation">automation</a>
                
                    <a href="/tags/azure-pipelines.yml">azure-pipelines.yml</a>
                
                    <a href="/tags/hugo">hugo</a>
                
                    <a href="/tags/static-site-generator">static site generator</a>
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="https://zacharyloeber-dev.onrender.com/blog/2019/12/8/hugo-a-devops-approach/">Hugo - A Devops Approach</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber-dev.onrender.com/blog/2018/12/10/devops-tool-of-the-day-syncthing/">Devops: Tool of the day – Syncthing</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber-dev.onrender.com/blog/2018/09/28/devops-automating-kubernetes-deployments/">DevOps – Automating Kubernetes Deployments</a>
                    </li>
                
                </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>Categories</strong></a>
                <ul>
                
                    <li>
                        <a href="/categories/system-administration">System administration (130)</a>
                    </li>
                
                    <li>
                        <a href="/categories/microsoft">Microsoft (120)</a>
                    </li>
                
                    <li>
                        <a href="/categories/powershell">Powershell (106)</a>
                    </li>
                
                    <li>
                        <a href="/categories/networking">Networking (53)</a>
                    </li>
                
                    <li>
                        <a href="/categories/active-directory">Active directory (44)</a>
                    </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                    <a href="https://twitter.com/zloeber" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                
                
                
                
                
                
                    <a href="https://github.com/zloeber" target="_blank"><i class="fa fa-github"></i></a>
                
                
                    <a href="https://www.linkedin.com/in/zloeber/" target="_blank"><i class="fa fa-linkedin"></i></a>
                
            </div>
            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/zloeber" target="_blank">
                &copy;
                
                    2019
                
                by Zachary Loeber
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        

        

        
        
        <script type="text/javascript" src="/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
                <script src="https://zacharyloeber-dev.onrender.com/js/mermaid.js" type="application/javascript"></script>
            
        

        


    </body>
</html>
